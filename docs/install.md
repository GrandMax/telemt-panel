# Установка telemt через скрипт (Docker + Traefik)

Скрипт `install.sh` в корне репозитория разворачивает MTProxy с Fake TLS за Traefik: один порт 443, маршрутизация по SNI, сборка telemt из исходников в Docker.

## Требования

- Docker и Docker Compose
- Запуск скрипта из корня репозитория telemt (нужны шаблоны из каталога `install/`)

## Установка и управление

Из корня репозитория запустите:

```bash
./install.sh
```

**При запуске без аргументов** (в терминале с TTY) отображается **интерактивное меню**:

1) Установка (новая установка в каталог)  
2) Обновление (пересборка и перезапуск)  
3) Смена домена (SNI)  
4) Удаление  
5) Выход  

Выберите пункт (1–5). Дальше скрипт запросит все нужные параметры диалогами: каталог установки, порт, домен для Fake TLS (SNI), подтверждения. Управление полностью внутри скрипта, без ключей в командной строке.

При выборе **Установка** по шагам запрашиваются: каталог (по умолчанию `./mtproxy-data`), порт (443 или 1443 при занятости), домен маскировки (по умолчанию `1c.ru`), подтверждение. В конце выводится ссылка `tg://proxy?server=...&port=...&secret=...` — добавьте её в Telegram (Настройки → Данные и память → Использовать прокси).

## Режим без меню (автоматизация)

Для скриптов и CI можно передать действие первым аргументом; параметры задаются переменными окружения (см. ниже):

```bash
./install.sh install            # установка (параметры из env)
./install.sh update             # обновление (INSTALL_DIR из env)
./install.sh config --sni example.com  # смена домена без TTY
./install.sh uninstall -y       # удаление без подтверждения (INSTALL_DIR из env)
```

## Переменные окружения

При запуске без TTY (например из CI или по SSH без интерактива) можно задать параметры через переменные:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `INSTALL_DIR` | Каталог установки | `$(pwd)/mtproxy-data` |
| `LISTEN_PORT` | Порт прокси на хосте | `443` |
| `FAKE_DOMAIN` | Домен для Fake TLS (SNI) | `1c.ru` |
| `FAKE_DOMAIN_FROM_ENV` | То же (приоритет при установке) | — |
| `TELEMT_INTERNAL_PORT` | Внутренний порт telemt в Docker | `1234` |

Пример неинтерактивной установки:

```bash
INSTALL_DIR=/opt/mtproxy FAKE_DOMAIN=sberbank.ru ./install.sh
```

## Смена домена (SNI)

После установки домен маскировки можно изменить без переустановки:

- **Через меню**: запустите `./install.sh`, выберите «3) Смена домена (SNI)», укажите каталог установки и новый домен (текущий подставляется по умолчанию).
- **Без TTY**: `./install.sh config --sni другой-домен.ru` (каталог из `INSTALL_DIR`).

Обновляются `telemt.toml` (поле `tls_domain`) и правило SNI в `traefik/dynamic/tcp.yml`; контейнеры перезапускаются, выводится новая ссылка для Telegram.

## Полезные команды

- Логи: `cd <каталог_установки> && docker compose logs -f`
- Остановка: `cd <каталог_установки> && docker compose down`
- Перезапуск после ручного изменения конфигов: `docker compose up -d --force-recreate`

## Устранение проблем

- **Не подключается к прокси в Telegram** — проверьте, что порт открыт в файрволе и в панели VPS/облака; что в ссылке указан правильный IP сервера (`curl -s ifconfig.me`); что домен в ссылке совпадает с `tls_domain` в `telemt.toml` и с правилом HostSNI в `traefik/dynamic/tcp.yml`.
- **Ошибки при сборке** — убедитесь, что скрипт запущен из корня репозитория и в нём есть каталог `install/` с шаблонами и `Dockerfile`.

## Безопасность

- Ссылку прокси не публикуйте.
- Рекомендуется порт 443 и домен маскировки с рабочим HTTPS (например 1c.ru, sberbank.ru).

## Чек-лист тестирования скрипта

- [ ] **Меню** — запуск `./install.sh` без аргументов: отображается меню 1–5, выбор пункта ведёт к соответствующим запросам (каталог, порт, домен и т.д.).
- [ ] **Установка** — из меню выбрать 1), ввести каталог/порт/домен. Проверить: создан каталог установки, `docker compose ps` показывает traefik и telemt, выведена ссылка.
- [ ] **Обновление** — из меню выбрать 2), указать каталог установки. Проверить: образ telemt пересобран, контейнеры перезапущены.
- [ ] **Смена домена** — из меню выбрать 3), указать каталог и новый домен. Проверить: в `telemt.toml` и `traefik/dynamic/tcp.yml` новый домен, выведена новая ссылка.
- [ ] **Удаление** — из меню выбрать 4), указать каталог и подтвердить. Проверить: контейнеры остановлены, каталог удалён.
- [ ] **Без TTY** — `INSTALL_DIR=... ./install.sh install` и при необходимости другие действия с аргументом. Проверить: выполнение без меню, параметры из env.
